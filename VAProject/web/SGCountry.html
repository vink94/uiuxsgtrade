<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Base CSS -->
        <link rel="stylesheet" href="assets/css/basestyle/style.css">

        <!-- Material Icons -->
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <title> IS428: SG Trade Visualization </title>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js" type="text/javascript"></script>
        <style>
            .group text {
                font: 11px sans-serif;
                pointer-events: none;
            }

            .group path {
                stroke: #000;
            }

            path.chord {
                stroke-width: .75;
                fill-opacity: .75;
            }

        </style>
    </head>

    <body>
        <!-- Pre Loader-->
        <div class="loader-wrapper">
            <div class="spinner">
                <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                <circle class="length" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="28"></circle>
                </svg>
                <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="28"></circle>
                </svg>
                <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="28"></circle>
                </svg>
                <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="28"></circle>
                </svg>
            </div>
        </div>
        <!-- Pre Loader-->

        <section class="wrapper">
            <!-- SIDEBAR -->
            <aside class="sidebar sidebar-light">
                <nav class="navbar navbar-light bg-white">
                    <a class="navbar-brand m-0 py-2 brand-title" href="#"> Visual Analytics </a>
                    <span></span>
                    <a class="navbar-brand py-2 material-icons toggle-sidebar" href="#">menu</a>
                </nav>

                <nav class="navigation">
                    <ul>
                        <li class=""><a href="index.html" title="Dashboard"><span class="nav-icon material-icons">public</span> Home </a></li>
                        <li class=""><a href="SGImportExport.html"><span class="nav-icon material-icons "> card_travel </span> SG Trades </a></li>
                        <li class=""><a href="ASEANTrades.html"><span class="nav-icon material-icons ">score</span> ASEAN Trades </a></li>
                        <li class="active"><a href="SGTrade.html"><span class="nav-icon material-icons ">score</span> SG Trade </a></li>
                    </ul>
                </nav>

            </aside>

            <div class="content-area">

                <header class="header sticky-top">
                    <nav class="navbar px-sm-4 navbar-light bg-white">
                        <a class="navbar-brand py-2 d-md-none  m-0 material-icons toggle-sidebar" href="#">menu</a>
                        <ul class="navbar-nav flex-row ml-auto">
                            <li class="nav-item" data-toggle="tooltip" data-placement="bottom" title="Switch Application">
                                <a data-toggle="modal" href="#" data-target="#switchApp" class="nav-link"><span class="material-icons align-middle">apps</span></a>
                            </li>
                            <li class="nav-item ml-sm-3 user-logedin dropdown">
                                <a href="https://wiki.smu.edu.sg/18191is428g1/UserImport/UserExport" target="_blank" class="nav-link weight-400"><img src="image/250px-UIUXLogo.png" class="mr-2 rounded" width="28"> User Export / User Import</a>
                            </li>
                        </ul>
                    </nav>
                </header>

                <div class="content-wrapper">
                    <div class="row page-tilte align-items-center">
                        <div class="col-md-12">
                            <a href="#" class="mt-3 d-md-none float-right toggle-controls"><span class="material-icons">keyboard_arrow_down</span></a>
                            <h1 class="weight-300 h3 title"> Chord Diagram </h1>
                        </div> 
                    </div> 

                    <div class="content">
                        <div class="form-group row">
                            <div class="col-sm-12">
                                <div id="container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="modal fade" id="switchApp" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header px-4">
                        <h5 class="modal-title" id="exampleModalLabel">Select Application</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span class="material-icons ">close</span>
                        </button>
                    </div>
                    <div class="modal-body p-4">

                        <div class="row align-items-stretch app-switcher">
                            <div class="col-lg-3 col-6 mb-4">
                                <a href="index.html" class="text-dark">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <span class="material-icons md-48 " style="color:#21C3E0;">bubble_chart</span>
                                            <p class="weight-400 m-0">Dashboard</p>
                                            <small class="weight-300 text-muted">This is some text within a card body.</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-lg-3 col-6 mb-4">
                                <a href="ecommerce-dashboard.html" class="text-dark">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <span class="material-icons md-48 text-primary">security</span>
                                            <p class="weight-400 m-0">Ecommerce</p>
                                            <small class="weight-300 text-muted">This is some text within a card body.</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-lg-3 col-6 mb-4">
                                <a href="mailbox.html" class="text-dark">
                                    <div class="card h-100 active-app">
                                        <div class="card-body text-center">
                                            <span class="material-icons md-48 text-danger">blur_on</span>
                                            <p class="weight-400 m-0">Mail Box</p>
                                            <small class="weight-300 text-muted">This is some text within a card body.</small>
                                            <span class="material-icons app-selected md-16">check</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="col-lg-3 col-6 mb-4">
                                <a href="blogger-feed-list.html" class="text-dark">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <span class="material-icons md-48 text-warning">camera</span>
                                            <p class="weight-400 m-0">Blogger</p>
                                            <small class="weight-300 text-muted">This is some text within a card body.</small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="assets/js/lib/moment.min.js"></script>
        <script src="assets/js/lib/jquery.min.js"></script>
        <script src="assets/js/lib/popper.min.js"></script>
        <script src="assets/js/bootstrap/bootstrap.min.js"></script>
        <script src="assets/js/chosen-js/chosen.jquery.js"></script>
        <script src="assets/js/custom.js">
        </script>
        <script>
            var importDataStorage = {}
            var exportDataStorage = {}
            var countryList = []

            $(document).ready(function () {
                $.ajax({
                    url: "data/processedImportData.csv",
                    success: function (response) {
                        for (i = 1; i < response.split("|").length; i++) {
                            dict = {}
                            for (y = 0; y < response.split("|")[i].split("\t").length - 1; y++) {
                                dict[response.split("|")[0].split("\t")[y]] = parseFloat(response.split("|")[i].split("\t")[y])
                            }
                            countryList.push(response.split("|")[i].split("\t")[18])
                            importDataStorage[response.split("|")[i].split("\t")[18]] = dict
                        }
                    }
                })

                $.ajax({
                    url: "data/processedExportData.csv",
                    success: function (response) {
                        for (i = 1; i < response.split("|").length; i++) {
                            dict = {}
                            for (y = 0; y < response[i].split("\t").length - 1; y++) {
                                dict[response.split("|")[0].split("\t")[y]] = parseFloat(response.split("|")[i].split("\t")[y])
                            }
                            exportDataStorage[response.split("|")[i].split("\t")[18]] = dict
                        }
                    }
                })
                countryList.pop()
                countryList.push("Singapore")

                setTimeout(function() {
                    processData(2000)
                }, 1000)
                
            })

            function processData(year) {
                finalMatrix = []
                for (c = 0; c < countryList.length; c++) {
                    list = []
                    for (c = 0; c < countryList.length; c++) {
                        list.push(0)
                    }
                    
                    if (importDataStorage[countryList[c]] !== undefined) {
                        list[countryList.indexOf(countryList[c])] = importDataStorage[countryList[c]][year]
                        finalMatrix.push.apply(list)
                    }
                }
                console.log(finalMatrix)
            }
        </script>
        <script>
            /*** Define parameters and tools ***/
            var width = 760,
                    height = 650,
                    outerRadius = Math.min(width, height) / 2 - 120, //100,
                    innerRadius = outerRadius - 10;

            //string url for the initial data set
            //would usually be a file path url, here it is the id
            //selector for the <pre> element storing the data

            //create number formatting functions
            var formatPercent = d3.format("%");
            var numberWithCommas = d3.format("0,f");

            //create the arc path data generator for the groups
            var arc = d3.svg.arc()
                    .innerRadius(innerRadius)
                    .outerRadius(outerRadius);

//create the chord path data generator for the chords
            var path = d3.svg.chord()
                    .radius(innerRadius - 4);// subtracted 4 to separate the ribbon

//define the default chord layout parameters
//within a function that returns a new layout object;
//that way, you can create multiple chord layouts
//that are the same except for the data.
            function getDefaultLayout() {
                return d3.layout.chord()
                        .padding(0.03)
                        .sortSubgroups(d3.descending)
                        .sortChords(d3.ascending);
            }
            var last_layout; //store layout between updates
            var regions; //store neighbourhood data outside data-reading function

            /*** Initialize the visualization ***/
            var g = d3.select("#container").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("id", "circle")
                    .attr("transform",
                            "translate(" + width / 2 + "," + height / 2 + ")");
//the entire graphic will be drawn within this <g> element,
//so all coordinates will be relative to the center of the circle

            g.append("circle")
                    .attr("r", outerRadius);
//this circle is set in CSS to be transparent but to respond to mouse events
//It will ensure that the <g> responds to all mouse events within
//the area, even after chords are faded out.

            /*** Read in the neighbourhoods data and update with initial data matrix ***/
//normally this would be done with file-reading functions
//d3. and d3.json and callbacks, 
//instead we're using the string-parsing functions
//d3.csv.parse and JSON.parse, both of which return the data,
//no callbacks required. 

            //updateChords("2013")

            /* Create OR update a chord layout from a data matrix */
            function updateChords(matrix) {
                /* Compute chord layout. */
                layout = getDefaultLayout(); //create a new layout object
                layout.matrix(matrix);

                /* Create/update "group" elements */
                var groupG = g.selectAll("g.group")
                        .data(layout.groups(), function (d) {
                            return d.index;
                            //use a key function in case the 
                            //groups are sorted differently 
                        });

                groupG.exit()
                        .transition()
                        .duration(1500)
                        .attr("opacity", 0)
                        .remove(); //remove after transitions are complete

                var newGroups = groupG.enter().append("g")
                        .attr("class", "group");
                //the enter selection is stored in a variable so we can
                //enter the <path>, <text>, and <title> elements as well


                //Create the title tooltip for the new groups
                newGroups.append("title");

                //Update the (tooltip) title text based on the data
                groupG.select("title")
                        .text(function (d, i) {
                            return numberWithCommas(d.value)
                                    + " x (10\u00B3) in USD exports from "
                                    + regions[i].name;
                        });

                //create the arc paths and set the constant attributes
                //(those based on the group index, not on the value)
                newGroups.append("path")
                        .attr("id", function (d) {
                            return "group" + d.index;
                            //using d.index and not i to maintain consistency
                            //even if groups are sorted
                        })
                        .style("fill", function (d) {
                            return regions[d.index].color;
                        });

                //update the paths to match the layout
                groupG.select("path")
                        .transition()
                        .duration(1500)
                        //.attr("opacity", 0.5) //optional, just to observe the transition////////////
                        .attrTween("d", arcTween(last_layout))
                        // .transition().duration(100).attr("opacity", 1) //reset opacity//////////////
                        ;

                //create the group labels
                newGroups.append("svg:text")
                        .attr("xlink:href", function (d) {
                            return "#group" + d.index;
                        })
                        .attr("dy", ".35em")
                        .attr("color", "#fff")
                        .text(function (d) {
                            return regions[d.index].name;
                        });

                //position group labels to match layout
                groupG.select("text")
                        .transition()
                        .duration(1500)
                        .attr("transform", function (d) {
                            d.angle = (d.startAngle + d.endAngle) / 2;
                            //store the midpoint angle in the data object

                            return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")" +
                                    " translate(" + (innerRadius + 26) + ")" +
                                    (d.angle > Math.PI ? " rotate(180)" : " rotate(0)");
                            //include the rotate zero so that transforms can be interpolated
                        })
                        .attr("text-anchor", function (d) {
                            return d.angle > Math.PI ? "end" : "begin";
                        });


                /* Create/update the chord paths */
                var chordPaths = g.selectAll("path.chord")
                        .data(layout.chords(), chordKey);
                //specify a key function to match chords
                //between updates


                //create the new chord paths
                var newChords = chordPaths.enter()
                        .append("path")
                        .attr("class", "chord");

                // Add title tooltip for each new chord.
                newChords.append("title");

                // Update all chord title texts
                chordPaths.select("title")
                        .text(function (d) {
                            if (regions[d.target.index].name !== regions[d.source.index].name) {
                                return [numberWithCommas(d.source.value),
                                    " exports from ",
                                    regions[d.source.index].name,
                                    " to ",
                                    regions[d.target.index].name,
                                    "\n",
                                    numberWithCommas(d.target.value),
                                    " exports from ",
                                    regions[d.target.index].name,
                                    " to ",
                                    regions[d.source.index].name
                                ].join("");
                                //joining an array of many strings is faster than
                                //repeated calls to the '+' operator, 
                                //and makes for neater code!
                            } else { //source and target are the same
                                return numberWithCommas(d.source.value)
                                        + " exports ended in "
                                        + regions[d.source.index].name;
                            }
                        });

                //handle exiting paths:
                chordPaths.exit().transition()
                        .duration(1500)
                        .attr("opacity", 0)
                        .remove();

                //update the path shape
                chordPaths.transition()
                        .duration(1500)
                        //.attr("opacity", 0.5) //optional, just to observe the transition
                        .style("fill", function (d) {
                            return regions[d.source.index].color;
                        })
                        .attrTween("d", chordTween(last_layout))
                        //.transition().duration(100).attr("opacity", 1) //reset opacity
                        ;

                //add the mouseover/fade out behaviour to the groups
                //this is reset on every update, so it will use the latest
                //chordPaths selection
                groupG.on("mouseover", function (d) {
                    chordPaths.classed("fade", function (p) {
                        //returns true if *neither* the source or target of the chord
                        //matches the group that has been moused-over
                        return ((p.source.index != d.index) && (p.target.index != d.index));
                    });
                });
                //the "unfade" is handled with CSS :hover class on g#circle
                //you could also do it using a mouseout event:
                /*
                 g.on("mouseout", function() {
                 if (this == g.node() )
                 //only respond to mouseout of the entire circle
                 //not mouseout events for sub-components
                 chordPaths.classed("fade", false);
                 });
                 */

                last_layout = layout; //save for next update
            }

            function arcTween(oldLayout) {
                //this function will be called once per update cycle

                //Create a key:value version of the old layout's groups array
                //so we can easily find the matching group 
                //even if the group index values don't match the array index
                //(because of sorting)
                var oldGroups = {};
                if (oldLayout) {
                    oldLayout.groups().forEach(function (groupData) {
                        oldGroups[ groupData.index ] = groupData;
                    });
                }

                return function (d, i) {
                    var tween;
                    var old = oldGroups[d.index];
                    if (old) { //there's a matching old group
                        tween = d3.interpolate(old, d);
                    } else {
                        //create a zero-width arc object
                        var emptyArc = {startAngle: d.startAngle,
                            endAngle: d.startAngle};
                        tween = d3.interpolate(emptyArc, d);
                    }

                    return function (t) {
                        return arc(tween(t));
                    };
                };
            }

            function chordKey(data) {
                return (data.source.index < data.target.index) ?
                        data.source.index + "-" + data.target.index :
                        data.target.index + "-" + data.source.index;

                //create a key that will represent the relationship
                //between these two groups *regardless*
                //of which group is called 'source' and which 'target'
            }
            function chordTween(oldLayout) {
                //this function will be called once per update cycle

                //Create a key:value version of the old layout's chords array
                //so we can easily find the matching chord 
                //(which may not have a matching index)

                var oldChords = {};

                if (oldLayout) {
                    oldLayout.chords().forEach(function (chordData) {
                        oldChords[ chordKey(chordData) ] = chordData;
                    });
                }

                return function (d, i) {
                    //this function will be called for each active chord

                    var tween;
                    var old = oldChords[ chordKey(d) ];
                    if (old) {
                        //old is not undefined, i.e.
                        //there is a matching old chord value

                        //check whether source and target have been switched:
                        if (d.source.index != old.source.index) {
                            //swap source and target to match the new data
                            old = {
                                source: old.target,
                                target: old.source
                            };
                        }

                        tween = d3.interpolate(old, d);
                    } else {
                        //create a zero-width chord object
///////////////////////////////////////////////////////////in the copy ////////////////            
                        if (oldLayout) {
                            var oldGroups = oldLayout.groups().filter(function (group) {
                                return ((group.index == d.source.index) ||
                                        (group.index == d.target.index))
                            });
                            old = {source: oldGroups[0],
                                target: oldGroups[1] || oldGroups[0]};
                            //the OR in target is in case source and target are equal
                            //in the data, in which case only one group will pass the
                            //filter function

                            if (d.source.index != old.source.index) {
                                //swap source and target to match the new data
                                old = {
                                    source: old.target,
                                    target: old.source
                                };
                            }
                        } else
                            old = d;
                        /////////////////////////////////////////////////////////////////               
                        var emptyChord = {
                            source: {startAngle: old.source.startAngle,
                                endAngle: old.source.startAngle},
                            target: {startAngle: old.target.startAngle,
                                endAngle: old.target.startAngle}
                        };
                        tween = d3.interpolate(emptyChord, d);
                    }

                    return function (t) {
                        //this function calculates the intermediary shapes
                        return path(tween(t));
                    };
                };
            }

            //updateChords("foursix.json");

            /*
             function disableButton(buttonNode) {
             d3.selectAll("button")
             .attr("disabled", function(d) {
             return this === buttonNode? "true": null;
             });
             }
             */
        </script>
    </body>
</html>
